# 🚀 项目待办事项与问题

## 优先级分类

- **P0**: 关键修复/必须处理的问题
- **P1**: 重要功能/改进
- **P2**: 次要功能/改进
- **P3**: 可选改进/质量提升

## 已完成项目 ✅

- **每日猫语优化**: 将请求超时时间延长至 600 秒，避免前端过快报错无法连接服务器。
- **背景闪烁问题修复**: 通过 `LoadingContent` 组件解决界面切换时的背景闪烁问题。
- **毛玻璃效果优化**: 调整 blur 效果应用时机，确保界面一致性。
- **组件共享**: 抽取 `GeometricBackground` 和 `backdropBlurClass` 为可复用组件。
- **页面转场优化**: 改进 `PageTransition` 组件，提供更流畅的页面切换体验。

## 关键修复 (P0)

### 博客/日记系统问题

1. **博客内容不显示问题**:

   - **现象**: 博客列表中只显示标题和图片，不显示正文内容。
   - **原因**: 后端 `postController.js` 的 `getAllPosts` 函数使用 `SUBSTRING(p.content, 1, 150) AS content_preview`，但前端未正确渲染该字段。
   - **解决方案**:
     - 确认前端组件（如 `BlogPostCard.jsx`）添加 `<p>{post.content_preview}</p>` 渲染正文预览。
     - 或者修改后端 SQL 查询，直接返回完整内容。

2. **旧帖子丢失问题**:

   - **现象**: 账号功能上线前的博客帖子在列表中不可见。
   - **原因**: `postController.js` 中 `getAllPosts` 使用 `INNER JOIN users`，导致 `user_id` 为空或无效的旧帖子被排除。
   - **解决方案**:
     - 将 SQL 中的 `JOIN users u ON p.user_id = u.id` 修改为 `LEFT JOIN users u ON p.user_id = u.id`。
     - 前端处理 `username` 为空的情况，显示"佚名"或其他默认文本。

3. **博客删除功能修复**:
   - **现象**: 博客删除功能不正常工作。
   - **调试方法**:
     - 前端：检查删除按钮 `onClick` 是否正确调用 `api.js` 中的 `deletePost(postId)` 函数。
     - 后端：检查 `postController.js` 中 `deletePost` 函数的执行流程和权限验证。
     - 添加详细日志，确定问题所在。

### 认证与安全问题

1. **Cookie 名称不一致修复**:

   - **现象**: 认证可能在某些情况下失效。
   - **原因**: `authController.js` 使用 `'authToken'` 作为 Cookie 名，而 `authMiddleware.js` 使用 `'token'`。
   - **解决方案**: 统一 Cookie 名称，修改 `authController.js` 中的 Cookie 名为 `'token'`。

2. **Cookie Secure 属性修复**:
   - **现象**: 生产环境中 Cookie 的 `secure` 属性设为 `false`，降低了安全性。
   - **解决方案**: 修改 `authController.js` 中的 `secure: false` 为 `secure: process.env.NODE_ENV === 'production'`。

### 数据库与服务问题

1. **数据库初始化修复**:

   - **现象**: 服务器可能无法正确初始化数据库表。
   - **原因**: `server.js` 未调用 `db/database.js` 中的 `initializeDatabase` 函数。
   - **解决方案**: 在 `server.js` 的 `start` 函数内，`app.locals.pool = pool;` 之后添加 `await initializeDatabase(pool);`。

2. **代码冗余清理**:
   - **问题**: `server/server.js` 中存在重复的 `fortuneRoutes` 引入。
   - **解决方案**: 移除重复的 `require('./routes/fortuneRoutes')` 代码行。

## 重要功能/改进 (P1)

### 评论系统改进

1. **评论折叠功能**:

   - 默认只显示前 N 条评论（例如 3 或 5 条）。
   - 添加"查看更多评论"按钮，点击后显示剩余评论。
   - 在 `CommentSection.jsx` 组件中添加状态变量来控制显示的评论数量。

2. **评论按钮样式统一**:
   - 修改 `CommentSection.jsx` 中提交评论按钮的样式，使其与项目中其他按钮一致。
   - 参考 `LoginPage.jsx` 或 `NewPostForm.jsx` 中按钮的样式类。

### 内容展示改进

1. **长内容展示优化**:

   - 为博客中的长文本和大图片实现折叠/展开功能。
   - 使用 CSS `max-height` 和 "阅读更多" 按钮来控制内容显示。
   - 通过 React 状态管理展开/收起状态。

2. **作者 ID 显示修复**:
   - 移除前端组件中直接显示 `user_id` 的代码。
   - 替换为显示 `username` 或不显示作者信息。

### 记忆系统完善

1. **记忆添加功能实现**:
   - 在 `server/controllers/memoryController.js` 中实现 `addMemory` 函数。
   - 开发功能允许向 `user_memories` 表添加记忆条目。
   - 后期考虑添加前端界面供用户管理记忆。

### UI/UX 改进

1. **空状态优化**:

   - 优化各页面的空状态显示，如无消息、无博客等。
   - 添加友好的引导提示，鼓励用户创建内容。

2. **移动端响应优化**:
   - 进一步测试并优化在小屏幕设备上的显示效果。
   - 确保所有功能在移动设备上同样易用。

## 次要功能/改进 (P2)

### 安全与性能

1. **API 速率限制**:

   - 使用 `express-rate-limit` 为所有 API 端点添加速率限制。
   - 根据端点的敏感度和使用频率设置不同的限制规则。

2. **Token 过期检查**:
   - 在 `AuthContext.jsx` 初始化时解码 JWT 并检查 `exp` 声明。
   - 如果令牌已过期，主动清除状态并登出用户。

### 功能扩展

1. **博客搜索功能强化**:

   - 改进前端搜索体验，添加搜索提示和历史记录。
   - 优化后端全文搜索逻辑，提高搜索准确性。

2. **Admin 管理面板**:

   - 实现基础管理功能，允许管理用户、内容和记忆。
   - 添加统计和监控功能，帮助管理员了解系统状态。

3. **主题色彩定制**:
   - 允许用户选择界面主题色彩。
   - 实现色彩方案的保存与加载功能。

## 可选改进/质量提升 (P3)

### 代码质量

1. **单元/集成测试**:

   - 使用 Jest + Supertest 为关键后端逻辑添加测试。
   - 优先覆盖认证、权限和核心 CRUD 操作。

2. **依赖更新与安全审计**:

   - 定期运行 `npm audit`，及时处理安全风险。
   - 保持依赖包的更新，利用新特性和性能改进。

3. **代码清理与重构**:

   - 移除注释掉的代码和未使用的导入。
   - 统一代码风格和命名约定。
   - 抽取重复逻辑为可复用组件和函数。

4. **性能监控与优化**:
   - 添加性能监控工具，识别瓶颈。
   - 优化数据库查询和前端加载时间。
   - 考虑添加缓存机制减少重复计算和请求。

## 新功能计划

### AI 功能扩展

1. **🚀 长期记忆 (v2 - 向量检索)**:

   - 实现更自然的记忆检索逻辑，使用向量数据库。
   - 整合 Embedding 和相似度搜索到聊天流程。
   - 优化记忆的相关性和检索效率。

2. **Function Calling 集成**:

   - 使用 OpenAI Function Calling 功能增强 AI 能力。
   - 实现简单功能（搜索/天气等）作为示例。
   - 提供结构化的工具框架，便于未来扩展。

3. **图像生成集成**:
   - 在聊天中添加 AI 图像生成能力。
   - 实现与画廊的集成，允许保存生成的图像。
   - 考虑成本控制和防滥用措施。

### 内容与社区功能

1. **博客编辑器增强**:

   - 改进 Markdown 编辑器，添加实时预览功能。
   - 支持更多格式化选项和媒体嵌入。
   - 优化图片上传和管理体验。

2. **Zcanic 画廊**:

   - 实现图像展示功能，支持多种布局和过滤选项。
   - 允许从 AI 生成的图像保存到画廊。
   - 添加简单的图片管理功能。

3. **互动故事工坊**:

   - 实现交互式故事体验，让用户与 Zcanic 进行多轮对话式故事交互。
   - 使用精心设计的 Prompt 工程和状态管理实现沉浸式体验。
   - 考虑方案中提到的 Token 成本控制和滚动摘要等优化手段。

4. **用户个性化设置**:
   - 允许用户设置 AI 角色偏好和对话风格。
   - 提供更多个性化设置选项，如界面布局和功能偏好。

### 语音功能集成计划

#### 架构设计

1. **前后端交互模型**:

   - 前端通过 REST API 调用后端语音服务
   - 采用异步处理模式（生成语音可能需要时间）
   - 实现轮询或 WebSocket 机制获取语音生成状态

2. **数据流设计**:
   ```
   前端UI → 网站后端API → voice_app微服务 → Voicevox引擎
       ↑           ↑               |
       |           |               ↓
    音频播放 ← 音频URL缓存 ← 音频文件存储
   ```

#### 前端实现

1. **UI 组件开发** (P1):

   - 设计语音播放器组件(`src/components/ui/AudioPlayer.jsx`)
   - 创建语音加载状态指示器
   - 实现音量控制和播放控制
   - 添加语音功能切换开关

2. **状态管理** (P1):

   - 在 context 中添加语音状态管理(`src/context/VoiceContext.jsx`)
   - 跟踪语音请求状态：idle, loading, ready, error
   - 缓存已生成语音的 URL，避免重复请求

3. **API 客户端** (P1):
   - 创建语音服务 API 客户端(`src/services/voiceService.js`)
   - 实现错误处理和重试逻辑
   - 添加请求节流，防止过多并发请求

#### 后端实现

1. **接口开发** (P1):

   - 创建语音请求转发接口(`server/controllers/voiceController.js`)
   - 实现请求验证和参数检查
   - 添加请求日志和监控

2. **安全措施** (P2):

   - 实现 API 密钥验证
   - 添加请求速率限制
   - 设置跨域资源共享(CORS)策略

3. **缓存机制** (P2):
   - 实现 Redis 或本地缓存，存储文本到音频 URL 的映射
   - 设置合理的缓存过期策略
   - 添加缓存命中率监控

#### 用户体验优化

1. **无感知加载** (P2):

   - 预加载常用语音（如欢迎信息）
   - 实现后台加载机制，不阻塞用户交互
   - 添加优雅的失败回退（语音失败时显示文本）

2. **个性化设置** (P3):

   - 允许用户选择不同的语音角色
   - 提供语速和音量自定义选项
   - 保存用户首选项到本地存储

3. **辅助功能** (P3):
   - 为听障用户添加字幕显示选项
   - 实现键盘快捷键控制
   - 确保符合 WCAG 无障碍标准

#### 性能优化

1. **资源管理** (P2):

   - 实现定时任务清理未使用的音频文件
   - 监控存储空间使用情况
   - 优化音频文件大小（格式、压缩）

2. **负载处理** (P2):
   - 实现请求队列，防止 voice_app 过载
   - 设计合理的超时和重试策略
   - 考虑添加负载均衡机制

#### 集成测试

1. **组件测试** (P2):

   - 测试音频播放组件在各种条件下的行为
   - 验证错误处理和回退机制
   - 确保跨浏览器兼容性

2. **端到端测试** (P3):
   - 测试完整的语音生成和播放流程
   - 验证高负载情况下的系统表现
   - 测试不同网络条件下的表现

#### 监控与分析

1. **性能指标** (P2):

   - 跟踪语音请求响应时间
   - 监控语音服务可用性
   - 分析用户语音功能使用情况

2. **错误跟踪** (P2):
   - 实现语音请求错误日志和报警
   - 添加详细的错误上下文信息
   - 创建错误分析仪表板

#### 部署策略

1. **环境配置** (P1):

   - 开发环境：本地 Voicevox 引擎
   - 测试环境：独立部署的 voice_app
   - 生产环境：专用服务器资源

2. **服务编排** (P2):
   - 使用 Docker 容器化 voice_app
   - 实现自动化部署流程
   - 配置健康检查和自动重启

#### 实施计划

1. **第一阶段** (P1):

   - 基础前端播放器组件开发（3 天）
   - 后端转发 API 实现（2 天）
   - 状态管理和缓存机制（2 天）
   - 基本集成测试（1 天）
   - UI/UX 优化（2 天）

2. **第二阶段** (P2):
   - 高级用户设置（2 天）
   - 性能优化和监控（3 天）
   - 辅助功能支持（2 天）
   - 完整测试和文档（2 天）
   - 生产环境部署（1 天）

## 主要集成点

### 1. 聊天界面

- [ ] 在聊天消息中添加语音播放按钮
- [ ] 实现 AI 响应的自动语音转换
- [ ] 添加全局语音开关

### 2. 博客/日记系统

- [ ] 为博客文章添加语音朗读功能
- [ ] 实现段落级别的语音控制
- [ ] 添加朗读进度指示器

### 3. 每日猫语

- [ ] 为每日猫语添加语音播报功能
- [ ] 实现语音随文本同步动画
- [ ] 优化语音播放的时间控制

---

**注意**: 上述任务将根据项目发展阶段和资源情况进行优先级调整。记得定期更新此文档以反映项目的最新状态。

# Zcanic.xyz TODO 任务清单

## 🔔 紧急优先事项

- [ ] 修复移动端响应式布局问题
- [ ] 解决博客图片上传偶尔失败的错误
- [ ] 处理聊天会话在特定情况下丢失的问题

## 🚀 功能开发

### 语音功能集成（新增）

- [ ] **语音服务部署与集成** - 详见 [voice_app/VOICE_INTEGRATION_TODO.md](voice_app/VOICE_INTEGRATION_TODO.md)
  - [ ] 基础部署配置（第 1-5 天）
  - [ ] 前端集成开发（第 6-12 天）
  - [ ] 后端集成（第 13-17 天）
  - [ ] 性能优化与监控（第 18-21 天）
  - [ ] 测试与上线（贯穿全程）

### 其他功能

- [ ] 实现用户仪表盘，展示活动统计
- [ ] 优化博客编辑器，支持更多 Markdown 扩展语法
- [ ] 添加主题自定义功能，允许用户个性化界面
- [ ] 实现文章收藏和阅读列表功能

## 🛠️ 改进与优化

- [ ] 减少首屏加载时间
- [ ] 优化图片和资源加载策略
- [ ] 改进错误处理和用户提示
- [ ] 增强安全措施，特别是针对 XSS 和 CSRF
- [ ] 重构认证逻辑，提高安全性和可扩展性

## 📱 移动端优化

- [ ] 优化触摸交互体验
- [ ] 调整移动端布局和组件尺寸
- [ ] 实现针对低带宽环境的优化

## 🧪 测试与质量保证

- [ ] 编写更多单元测试，提高测试覆盖率
- [ ] 实现自动化 UI 测试
- [ ] 改进错误日志记录和分析

## 📚 文档与规范

- [ ] 更新 API 文档
- [ ] 完善开发指南和代码规范
- [ ] 创建用户帮助文档

## 💡 未来计划

- [ ] 探索添加视频内容支持
- [ ] 考虑实现多语言支持
- [ ] 研究集成更多 AI 功能
